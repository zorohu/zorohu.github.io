<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="hexo"><meta name="keyword" content=""><link rel="shortcut icon" href="/img/favicon.ico"><title>mysql死锁 Deadlock - AuthorZero的博客 | AuthorZero&#39;s Blog</title><link rel="canonical" href="https://authorzero.com/2023/02/25/mysql-lock/"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/hux-blog.min.css"><link rel="stylesheet" href="/css/highlight.css"><link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><script></script><meta name="generator" content="Hexo 6.3.0"></head><body ontouchstart=""><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">AuthorZero的博客</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archives/">Archives</a></li><li><a href="/tags/">Tags</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><style type="text/css">header.intro-header{background-image:url(post-bg-2023.jpg)}</style><header class="intro-header"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/#技术" title="技术">技术</a> <a class="tag" href="/tags/#数据库" title="数据库">数据库</a> <a class="tag" href="/tags/#mysql" title="mysql">mysql</a></div><h1>mysql死锁 Deadlock</h1><h2 class="subheading">&#34;项目中的死锁发现及解决思路&#34;</h2><span class="meta">Posted by author.zero on 2023-02-25</span></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><blockquote><p>“Only do what your heart tells you. ”</p></blockquote><h2 id="业务死锁背景"><a href="#业务死锁背景" class="headerlink" title="业务死锁背景"></a>业务死锁背景</h2><p>今天有用户反应后台系统时快时慢的，于是上服务器看了下日志。发现了很多死锁的异常情况，异常日志如下</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: Deadlock <span class="built_in">found</span> <span class="keyword">when</span> trying <span class="keyword">to</span> <span class="keyword">get</span> <span class="keyword">lock</span>; try restarting <span class="keyword">transaction</span></span><br></pre></td></tr></table></figure><p>在分析死锁的原因之前，先了解一下mysql的锁</p><h2 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h2><p>通过查看<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html">mysql的官方文档</a>，其中InnoDB引擎锁分为以下几种</p><ul><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-shared-exclusive-locks" title="Shared and Exclusive Locks">Shared and Exclusive Locks</a> [共享锁和独占锁]</p><ul><li>共享 ( <code>S</code> ) 锁允许持有锁的事务读取一行。</li><li>独占 ( <code>X</code> ) 锁允许持有锁的事务更新或删除行。</li></ul></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-intention-locks" title="Intention Locks">Intention Locks</a> [意向锁]</p><ul><li>意向共享锁 ( <code>IS</code> ) 表示事务打算在表中的各个行上设置共享锁。</li><li>意向排他锁 ( <code>IX</code> ) 表示事务打算在表中的各个行上设置排他锁。</li></ul></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-record-locks" title="Record Locks">Record Locks</a> [记录锁]</p></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-gap-locks" title="Gap Locks">Gap Locks</a> [间隙锁]</p></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-next-key-locks" title="Next-Key Locks">Next-Key Locks</a> [下一键锁]</p></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-insert-intention-locks" title="Insert Intention Locks">Insert Intention Locks</a> [插入意向锁]</p></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-auto-inc-locks" title="AUTO-INC Locks">AUTO-INC Locks</a> [AUTO-INC锁]</p></li><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-predicate-locks" title="Predicate Locks for Spatial Indexes">Predicate Locks for Spatial Indexes</a> [空间索引的谓词锁]</p></li></ul><p>InnoDB行锁模式兼容性列表：</p><table><thead><tr><th>当前锁模式&#x2F;是否兼容&#x2F;请求锁模式</th><th>X</th><th>IX</th><th>S</th><th>IS</th></tr></thead><tbody><tr><td>X</td><td>冲突</td><td>冲突</td><td>冲突</td><td>冲突</td></tr><tr><td>IX</td><td>冲突</td><td>兼容</td><td>冲突</td><td>兼容</td></tr><tr><td>S</td><td>冲突</td><td>冲突</td><td>兼容</td><td>兼容</td></tr><tr><td>IS</td><td>冲突</td><td>兼容</td><td>兼容</td><td>兼容</td></tr></tbody></table><p>如果一个事务请求的锁模式与当前的锁兼容，InnoDB就请求的锁授予该事务；反之，如果两者两者不兼容，该事务就要等待锁释放。</p><img class="shadow" width="1000" src="lock-innodb.png"> <small class="img-hint">innodb锁</small><h2 id="mysql锁和隔离级别的关系"><a href="#mysql锁和隔离级别的关系" class="headerlink" title="mysql锁和隔离级别的关系"></a>mysql锁和隔离级别的关系</h2><p>对于mysql来说主要关注两个隔离级别的区别</p><ol><li><code>READ COMMITTED</code> 读以提交</li></ol><blockquote><p>For locking reads (SELECT with FOR UPDATE or FOR SHARE), UPDATE statements, and DELETE statements, InnoDB locks only index records, not the gaps before them, and thus permits the free insertion of new records next to locked records. Gap locking is only used for foreign-key constraint checking and duplicate-key checking.</p><p>Using <code>READ COMMITTED</code> has additional effects:</p><ul><li>For <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/update.html" title="13.2.17 UPDATE Statement"><code>UPDATE</code></a> or <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/delete.html" title="13.2.2 DELETE Statement"><code>DELETE</code></a> statements, <code>InnoDB</code> holds locks only for rows that it updates or deletes. Record locks for nonmatching rows are released after MySQL has evaluated the <code>WHERE</code> condition. This greatly reduces the probability of deadlocks, but they can still happen.</li><li>For <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/update.html" title="13.2.17 UPDATE Statement"><code>UPDATE</code></a> statements, if a row is already locked, <code>InnoDB</code> performs a “semi-consistent” read, returning the latest committed version to MySQL so that MySQL can determine whether the row matches the <code>WHERE</code> condition of the <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/update.html" title="13.2.17 UPDATE Statement"><code>UPDATE</code></a>. If the row matches (must be updated), MySQL reads the row again and this time <code>InnoDB</code> either locks it or waits for a lock on it.</li></ul></blockquote><p>以上是mysql文档中对<code>READ COMMITTED</code>加锁类型的解释，大致意思如下：</p><blockquote><p>对于锁定读取（ <code>SELECT</code> 与 <code>FOR UPDATE</code> 或 <code>FOR SHARE</code> ）、 <code>FOR UPDATE</code> 语句和 <code>FOR SHARE</code> 语句， <code>InnoDB</code> 仅锁定索引记录，而不锁定它们之前的间隙，因此允许自由插入新的锁定记录旁边的记录。间隙锁定仅用于外键约束检查和重复键检查。<br>使用 READ COMMITTED 有额外的效果：</p><ul><li><p>对于 <code>UPDATE</code> 或 <code>DELETE</code> 语句， <code>InnoDB</code> 仅对其更新或删除的行持有锁。在 MySQL 评估了 <code>WHERE</code> 条件后，释放不匹配行的记录锁。这大大降低了死锁的可能性，但它们仍然会发生。</p></li><li><p>对于 <code>UPDATE</code> 语句，如果一行已经被锁定， <code>InnoDB</code> 执行“半一致”读取，将最新提交的版本返回给MySQL，以便MySQL判断该行是否匹配@1的 <code>WHERE</code> 条件# 。如果该行匹配（必须更新），MySQL 将再次读取该行，这次 <code>InnoDB</code> 要么锁定它，要么等待锁定它。</p></li></ul></blockquote><ol><li><code>REPEATABLE READ</code> (可重复读)</li></ol><blockquote><p>For <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_locking_read" title="locking read">locking reads</a> (<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/select.html" title="13.2.13 SELECT Statement"><code>SELECT</code></a> with <code>FOR UPDATE</code> or <code>FOR SHARE</code>), <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/update.html" title="13.2.17 UPDATE Statement"><code>UPDATE</code></a>, and <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/delete.html" title="13.2.2 DELETE Statement"><code>DELETE</code></a> statements, locking depends on whether the statement uses a unique index with a unique search condition, or a range-type search condition.</p><ul><li><p>For a unique index with a unique search condition, <code>InnoDB</code> locks only the index record found, not the <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_gap" title="gap">gap</a> before it.</p></li><li><p>For other search conditions, <code>InnoDB</code> locks the index range scanned, using <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_gap_lock" title="gap lock">gap locks</a> or <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_next_key_lock" title="next-key lock">next-key locks</a> to block insertions by other sessions into the gaps covered by the range. For information about gap locks and next-key locks, see <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html" title="15.7.1 InnoDB Locking">Section 15.7.1, “InnoDB Locking”</a>.</p></li></ul></blockquote><p>以上是mysql文档中对<code>REPEATABLE READ</code>加锁类型的解释，大致意思如下：</p><blockquote><p>对于锁定读取（ <code>SELECT</code> 与 <code>FOR UPDATE</code> 或 <code>FOR SHARE</code> ）、 <code>FOR UPDATE</code> 和 <code>FOR SHARE</code> 语句，锁定取决于语句是使用具有唯一搜索条件的唯一索引，还是范围类型的搜索条件.</p><ul><li>对于具有唯一搜索条件的唯一索引， InnoDB 只锁定找到的索引记录，而不锁定其之前的间隙。</li><li>对于其他搜索条件， <code>InnoDB</code> 锁定扫描的索引范围，使用间隙锁或next-key锁来阻止其他会话插入到该范围覆盖的间隙中。有关间隙锁和下一键锁的信息，请参阅第 15.7.1 节，“InnoDB 锁定”。</li></ul></blockquote><p>在RR隔离级别中，我们一般认为可以产生锁的语句为:</p><ul><li><code>SELECT ... FOR UPDATE</code>: X锁</li><li><code>SELECT ... LOCK IN SHARE MODE</code>: S锁</li><li><code>update/delete</code>: X锁</li></ul><table><thead><tr><th>索引</th><th>场景</th><th>锁范围</th></tr></thead><tbody><tr><td>无索引</td><td>S&#x2F;X锁</td><td>锁全表</td></tr><tr><td>唯一索引</td><td>精确匹配，且命中</td><td>行锁</td></tr><tr><td>唯一索引</td><td>精确匹配，未命中</td><td>gap lock</td></tr><tr><td>唯一索引</td><td>范围查询</td><td>next key lock (上个记录下个记录的区间，左闭右开） 右边记录行锁</td></tr><tr><td>普通索引</td><td>精确匹配，且命中</td><td>行锁 + gap lock (上一个记录和下个记录区间，左闭右开，左边记录非行锁)</td></tr><tr><td>普通索引</td><td>精确匹配，未命中</td><td>gap lock</td></tr><tr><td>普通索引</td><td>范围查询</td><td>next key lock</td></tr></tbody></table><h3 id="锁冲突"><a href="#锁冲突" class="headerlink" title="锁冲突"></a>锁冲突</h3><p>上面介绍了不同场景下会产生什么样的锁，但是看完之后会有一个疑问，针对行锁其他会话竞争的时候，可以按照X&#x2F;S锁的规则来，但是这个GAP LOCK貌似只针对insert有效，insert除了加X锁之外是不是还有其他的特殊逻辑？</p><h4 id="插入意向锁"><a href="#插入意向锁" class="headerlink" title="插入意向锁"></a>插入意向锁</h4><p>插入意向锁其实是一种特殊的 gap lock，但是它不会阻塞其他锁。假设存在值为 4 和 7 的索引记录，尝试插入值 5 和 6 的两个事务在获取插入行上的排它锁之前使用插入意向锁锁定间隙，即在（4，7）上加 gap lock，但是这两个事务不会互相冲突等待；但是如果这个区间存在gap lock，则会被阻塞；如果多个事务插入相同数据导致唯一冲突，则在重复的索引记录上加读锁</p><p>简单来说，它的属性为：</p><ul><li>它不会阻塞其他任何锁；</li><li>它本身仅会被 gap lock 阻塞</li></ul><p>其次一个重要知识点：</p><ul><li><p>通常insert语句，加的是行锁，排它锁</p></li><li><p>在insert之前，先通过插入意向锁，判断是否可以插入（仅会被gap lock阻塞）</p></li><li><p>当插入唯一冲突时，在重复索引上添加读锁</p></li><li><p>原因如下：</p></li><li><p>事务1 插入成功未提交，获取了排它锁，但是事务1最终可能会回滚，所以其他重复插入事务不应该直接失败，这个时候他们改为申请读锁（疑问点：为什么要改成读锁呢？）</p></li></ul><h4 id="锁冲突矩阵"><a href="#锁冲突矩阵" class="headerlink" title="锁冲突矩阵"></a>锁冲突矩阵</h4><p>简单版矩阵</p><table><thead><tr><th></th><th>共享锁（S）</th><th>排他锁（X）</th></tr></thead><tbody><tr><td>共享锁（S）</td><td>兼容</td><td>冲突</td></tr><tr><td>排他锁（X）</td><td>冲突</td><td>冲突</td></tr></tbody></table><p>当我们将gap lock(间隙锁), next key lock(next-key锁), Insert Intention lock(插入意向锁)也加入矩阵时，就会复杂很多了</p><table><thead><tr><th>行：待加锁；列：存在锁</th><th>S(not gap)</th><th>S(gap)</th><th>S(next key)</th><th>X(not gap)</th><th>X(gap)</th><th>X(next key)</th><th>Insert Intention</th></tr></thead><tbody><tr><td>S(not gap)</td><td>-</td><td>-</td><td>-</td><td>冲突</td><td>-</td><td>冲突</td><td>-</td></tr><tr><td>S(gap)</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>冲突</td></tr><tr><td>S(next-key)</td><td>-</td><td>-</td><td>-</td><td>冲突</td><td>-</td><td>冲突</td><td>冲突</td></tr><tr><td>X(not gap)</td><td>冲突</td><td>-</td><td>冲突</td><td>冲突</td><td>-</td><td>冲突</td><td>-</td></tr><tr><td>X(gap)</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>冲突</td></tr><tr><td>X(next-key)</td><td>冲突</td><td>-</td><td>冲突</td><td>冲突</td><td>-</td><td>冲突</td><td>冲突</td></tr><tr><td>Insert Intention</td><td>-</td><td>冲突</td><td>冲突</td><td>-</td><td>冲突</td><td>冲突</td><td>-</td></tr></tbody></table><p><strong>说明</strong></p><ul><li>not gap: 行锁</li><li>gap: gap lock</li><li>next-key: gap + 行锁</li></ul><p><strong>小结</strong></p><p>针对上面的矩阵，理解下面几个原则即可推导上面矩阵</p><ul><li><code>gap lock</code>只会与插入意向锁冲突</li><li>X行锁会与行锁冲突</li><li><code>next key lock</code>: 行锁 + gap锁<ul><li>锁区间内，插入冲突；</li><li>行锁的X锁冲突</li></ul></li></ul><blockquote><p>INSERT操作之间不会有冲突。<br>GAP,Next-Key会阻塞插入意向锁INSERT_INTENTION<br>GAP与Record,Next-Key不会冲突<br>Record与Record、Next-Key之间相互冲突。<br>已有的Insert锁不阻止任何准备加的锁。</p></blockquote><p><strong>另外</strong> RR事务隔离级别下,对于通过索引(唯一或者非唯一)更新或者删除不存在的记录，会申请加上gap锁。</p><blockquote><p>当update 更新被索引字段时，相当于删除之后重新插入新的记录，需要重新组织索引节点。</p></blockquote><h2 id="死锁日志分析"><a href="#死锁日志分析" class="headerlink" title="死锁日志分析"></a>死锁日志分析</h2><p>mysql使用 <code>SHOW ENGINE INNODB STATUS</code> 查看最后一次死锁的日志</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="number">2023</span><span class="number">-02</span><span class="number">-25</span> <span class="number">12</span>:<span class="number">45</span>:<span class="number">10</span> <span class="number">0x7fcb7c81d700</span> INNODB MONITOR OUTPUT</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line"><span class="keyword">Per</span> <span class="keyword">second</span> averages calculated <span class="keyword">from</span> the <span class="keyword">last</span> <span class="number">42</span> seconds</span><br><span class="line"><span class="comment">-----------------</span></span><br><span class="line">BACKGROUND THREAD</span><br><span class="line"><span class="comment">-----------------</span></span><br><span class="line">srv_master_thread loops: <span class="number">7028552</span> srv_active, <span class="number">0</span> srv_shutdown, <span class="number">12417742</span> srv_idle</span><br><span class="line">srv_master_thread log flush <span class="keyword">and</span> writes: <span class="number">0</span></span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">SEMAPHORES</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">OS WAIT <span class="keyword">ARRAY</span> INFO: reservation count <span class="number">34638</span></span><br><span class="line">OS WAIT <span class="keyword">ARRAY</span> INFO: signal count <span class="number">41648</span></span><br><span class="line">RW<span class="operator">-</span>shared spins <span class="number">41021</span>, rounds <span class="number">44749</span>, OS waits <span class="number">3915</span></span><br><span class="line">RW<span class="operator">-</span>excl spins <span class="number">31944</span>, rounds <span class="number">298720</span>, OS waits <span class="number">6485</span></span><br><span class="line">RW<span class="operator">-</span>sx spins <span class="number">925</span>, rounds <span class="number">15739</span>, OS waits <span class="number">307</span></span><br><span class="line">Spin rounds <span class="keyword">per</span> wait: <span class="number">1.09</span> RW<span class="operator">-</span>shared, <span class="number">9.35</span> RW<span class="operator">-</span>excl, <span class="number">17.02</span> RW<span class="operator">-</span>sx</span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line"><span class="number">2023</span><span class="number">-02</span><span class="number">-24</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">00</span> <span class="number">0x7fcbcc39e700</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">1</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">142598476</span>, ACTIVE <span class="number">1</span> sec inserting</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">39</span> lock struct(s), heap size <span class="number">3520</span>, <span class="number">20</span> <span class="type">row</span> lock(s), undo log entries <span class="number">2</span></span><br><span class="line">MySQL thread id <span class="number">304122</span>, OS thread handle <span class="number">140511974713088</span>, query id <span class="number">863419238</span> node26.hadoop.com <span class="number">20.20</span><span class="number">.0</span><span class="number">.26</span> user1 <span class="keyword">update</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> biz  ( id,</span><br><span class="line">min_id</span><br><span class="line">)  <span class="keyword">VALUES</span>  (\<span class="string">&#x27;1628949431793971202\&#x27;</span>, \<span class="string">&#x27;50010113921400054-002010162280990000\&#x27;</span>)</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">1</span>) WAITING <span class="keyword">FOR</span> THIS LOCK <span class="keyword">TO</span> BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">769</span> page <span class="keyword">no</span> <span class="number">560</span> n bits <span class="number">240</span> index uq_minid <span class="keyword">of</span> <span class="keyword">table</span> `<span class="keyword">table</span>`.`biz` trx id <span class="number">142598476</span> <span class="operator">&lt;</span>font color<span class="operator">=</span>#FF0000<span class="operator">&gt;</span>lock_mode X locks gap before rec <span class="keyword">insert</span> intention waiting<span class="operator">&lt;</span><span class="operator">/</span>font<span class="operator">&gt;</span></span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">170</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">30</span>; hex <span class="number">35303031303131333932313430303037382</span>d303030333432303832353335; <span class="keyword">asc</span> <span class="number">50010113921400078</span><span class="number">-000342082535</span>; (total <span class="number">37</span> bytes);</span><br><span class="line"> <span class="number">1</span>: len <span class="number">19</span>; hex <span class="number">31363238393439333439303036373938383530</span>; <span class="keyword">asc</span> <span class="number">1628949349006798850</span>;;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">2</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">142598478</span>, ACTIVE <span class="number">0</span> sec inserting</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">39</span> lock struct(s), heap size <span class="number">3520</span>, <span class="number">20</span> <span class="type">row</span> lock(s), undo log entries <span class="number">2</span></span><br><span class="line">MySQL thread id <span class="number">304144</span>, OS thread handle <span class="number">140513281435392</span>, query id <span class="number">863419247</span> node25.hadoop.com <span class="number">20.20</span><span class="number">.0</span><span class="number">.25</span> user1 <span class="keyword">update</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> biz  ( id,</span><br><span class="line">min_id)  </span><br><span class="line"><span class="keyword">VALUES</span>  (\<span class="string">&#x27;1628948813789921282\&#x27;</span>, \<span class="string">&#x27;50010113921400054-002010162280990000\&#x27;</span>)</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id <span class="number">769</span> page <span class="keyword">no</span> <span class="number">560</span> n bits <span class="number">240</span> index uq_minid <span class="keyword">of</span> <span class="keyword">table</span> `<span class="keyword">table</span>`.`biz` trx id <span class="number">142598478</span> lock_mode X locks gap before rec</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">170</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">30</span>; hex <span class="number">35303031303131333932313430303037382</span>d303030333432303832353335; <span class="keyword">asc</span> <span class="number">50010113921400078</span><span class="number">-000342082535</span>; (total <span class="number">37</span> bytes);</span><br><span class="line"> <span class="number">1</span>: len <span class="number">19</span>; hex <span class="number">31363238393439333439303036373938383530</span>; <span class="keyword">asc</span> <span class="number">1628949349006798850</span>;;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> (<span class="number">2</span>) WAITING <span class="keyword">FOR</span> THIS LOCK <span class="keyword">TO</span> BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">769</span> page <span class="keyword">no</span> <span class="number">560</span> n bits <span class="number">240</span> index uq_minid <span class="keyword">of</span> <span class="keyword">table</span> `<span class="keyword">table</span>`.`biz` trx id <span class="number">142598478</span> lock_mode X locks gap before rec <span class="keyword">insert</span> intention waiting </span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">170</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">30</span>; hex <span class="number">35303031303131333932313430303037382</span>d303030333432303832353335; <span class="keyword">asc</span> <span class="number">50010113921400078</span><span class="number">-000342082535</span>; (total <span class="number">37</span> bytes);</span><br><span class="line"> <span class="number">1</span>: len <span class="number">19</span>; hex <span class="number">31363238393439333439303036373938383530</span>; <span class="keyword">asc</span> <span class="number">1628949349006798850</span>;;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> WE ROLL BACK TRANSACTION (<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>从以上事务可以分析出</p><ul><li>TRANSACTION(1) lock_mode X locks gap before rec insert intention waiting</li><li>TRANSACTION(2) lock_mode X locks gap before rec</li><li>TRANSACTION(2) lock_mode X locks gap before rec insert intention waiting</li><li>ROLL BACK TRANSACTION (2)</li></ul><p>主要的问题在于</p><blockquote><p>当对存在的行进行锁的时候(主键)，mysql就只有行锁。<br>当对未存在的行进行锁的时候(即使条件为主键)，mysql是会锁住一段范围（有gap锁）</p></blockquote><p>而我的业务正好插入的时候唯一建不一定存在，所以导致gap锁，而插入意向锁不会冲突，所以两个事务都拿到了插入意向锁。而只会有一个事务会获取到gap锁</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>当把死锁的情况分析完成后，其实解决起来就比较简单了</p><ul><li>修改隔离级别，避免间隙锁(只有RR级别有间隙锁)</li><li>加入分布式锁，如：redis，zookpper等。即减少并发</li><li>并发插入时使用replace&#x2F;on duplicate也可以避免死锁</li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html">mysql官方文档</a></p></li><li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/myitnews/p/13698029.html">MySQL锁的分类</a></p></li><li><p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2014/08/20/innodb-lock.html">Innodb中的事务隔离级别和锁的关系</a></p></li><li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8c7a14b7feac">Mysql Insert 死锁问题研究</a></p></li><li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f9a344c0dcf1">并发插入引发的死锁案例分析</a></p></li><li><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7020035209584181255">MySQL这些锁知识</a></p></li><li><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1181190?from=15425&areaSource=102001.1&traceId=UeL1dFR9MxdVzeRQagYhZ">锁日志解读</a></p></li><li><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1181187?areaSource=&traceId=">死锁案例分析</a></p></li></ul><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><img class="shadow" width="1000" src="lock-mode.png"> <small class="img-hint">锁总结</small><p align="right">—— author.zero 后记于 2023.2.25</p><hr><ul class="pager"><li class="previous"><a href="/2023/03/05/tools-proxy/" data-toggle="tooltip" data-placement="top" title="whistle web开发调试神器">&larr; Previous Post</a></li><li class="next"><a href="/2023/02/05/hello-2023/" data-toggle="tooltip" data-placement="top" title="Welcome to new author.zero Blog">Next Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container"><div class="side-catalog"><hr class="hidden-sm hidden-xs"><h5><a class="catalog-toggle" href="#">CATALOG</a></h5><ul class="catalog-body"></ul></div></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/tags/">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/tags/#技术" title="技术">技术</a> <a class="tag" href="/tags/#数据库" title="数据库">数据库</a> <a class="tag" href="/tags/#mysql" title="mysql">mysql</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="http://blog.kaijun.rocks" target="_blank">Kaijun&#39;s Blog</a></li><li><a href="http://huangxuan.me" target="_blank">Hux Blog</a></li><li><a href="#" target="_blank">Foo</a></li><li><a href="#" target="_blank">Bar</a></li><li><a href="#" target="_blank">Example Friends</a></li><li><a href="#" target="_blank">It helps SEO</a></li></ul></div></div></div></article><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"always",placement:"right",icon:"#"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style>@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" href="https://twitter.com/author22282473"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.zhihu.com/people/auth0"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li><li><a target="_blank" href="https://weibo.com/ZoroP"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-weibo fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.facebook.com/author.zero"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://github.com/zorohu"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.linkedin.com/in/author.zero"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; AuthorZero的博客 2018 - 2023 <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">鄂ICP备20003318号</a><br>Theme by <a target="_blank" rel="noopener" href="https://huangxuan.me">Hux</a> <span style="display:inline-block;margin:0 5px"><i class="fa fa-heart"></i> </span>Ported by <a target="_blank" rel="noopener" href="https://blog.kaijun.rocks">Kaijun</a> |<iframe style="margin-left:2px;margin-bottom:-5px" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true"></iframe><br><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次 本站访客数<span id="busuanzi_value_site_uv"></span>人次 本文总阅读量<span id="busuanzi_value_page_pv"></span>次</span><br><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date(2018,4,13,19,23,16);now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script></p></div></div></div></footer><script src="/js/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/hux-blog.min.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>0!==$("#tag_cloud").length&&async("https://authorzero.com/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _gaId="UA-49627206-1",_gaDomain="huangxuan.me";!function(a,e,n,g,t,c){a.GoogleAnalyticsObject=g,a.ga=a.ga||function(){(a.ga.q=a.ga.q||[]).push(arguments)},a.ga.l=+new Date,t=e.createElement(n),c=e.getElementsByTagName(n)[0],t.async=1,t.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(t,c)}(window,document,"script","ga"),ga("create",_gaId,_gaDomain),ga("send","pageview")</script><script>var _baId="4cc1f2d8f3067386cc5cdb626a202900",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(e,c)}()</script><script type="text/javascript">function generateCatalog(e){_containerSelector="div.post-container";var a,l,n,t,o,c=$(_containerSelector).find("h1,h2,h3,h4,h5,h6");return $(e).html(""),c.each(function(){a=$(this).prop("tagName").toLowerCase(),t="#"+$(this).prop("id"),l=$(this).text(),o=$('<a href="'+t+'" rel="nofollow">'+l+"</a>"),n=$('<li class="'+a+'_nav"></li>').append(o),$(e).append(n)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),async("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><img src="https://authorzero.com/img/icon_wechat.png" width="0" height="0"></body></html>